(()=>{"use strict";function e(e,t,n,o="defaultValue"){const c=document.createElement(e);return t&&c.classList.add(t),n&&(c.innerText=n),c}function t(t,n){const o=e("label","checkbox");o.classList.add("style-e");const c=e("input","checkbox__checkbox");c.type="checkbox",c.value=t;const r=e("div","checkbox__checkmark"),a=e("div","checkbox__body",t);return o.appendChild(c),o.appendChild(r),o.appendChild(a),o}function n(e,t,n="default"){let c=[...e];c.sort(((e,t)=>e[n]<t[n]?-1:e[n]>t[n]?1:0)),o(c,t)}function o(e,t,n){t.innerHTML="";const o=new Set,a=e=>{const n=document.createElement("tr");e.forEach((e=>{const t=document.createElement("td");"string"==typeof e||"number"==typeof e?t.textContent=e.toString():e instanceof HTMLElement&&t.appendChild(e),n.appendChild(t)})),t.appendChild(n)};e.forEach((e=>{const{name:t,namelink:n,shop:l,shopLink:i,price:s,bonus:d,total:u,promocode:p}=e,m=`${t}-${l}`;if(!o.has(m))if(o.add(m),null===p){const e=[r(n,t),c(n,l),s,d,u,"-"];a(e)}else{const e=[r(n,t),c(n,l),s,d,u,p];a(e)}}))}const c=(e,t="")=>{const n=document.createElement("a");return n.href=e,n.textContent=t,n.addEventListener("click",(t=>{t.preventDefault();let o=async function(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Ошибка при выполнении перехода: "+t.status);const n=await t.text(),o=document.createElement("div");o.innerHTML=n;let c=o.querySelector(".pdp-merchant-rating-block__rating");return c=parseFloat(c.innerText.replace(/\s+/g,"")),4.1===c?"red":c<4&&c>=3?"yellow":"red"}catch(e){console.error("Ошибка при выполнении перехода:",e)}}(e);o&&(n.style.color=o)})),n},r=(e,t="")=>{const n=document.createElement("a");return n.href=e,n.textContent=t,n.target="_blank",n};function a(e){return 0===e.length?"Количество товаров: "+Array.from(document.querySelectorAll(".catalog-item:not(.catalog-item_out-of-stock):not(.catalog-item_banner):not(.catalog-item_banner")).length:"Количество товаров: "+e.length}function l(e,t,n){let o=0,c=null;for(const n in t){const r=t[n];for(const t of r)e>=t.price_to&&t.discount>o&&(o=t.discount,c=n)}return"price"===n?e-o:"promo"===n?c:void 0}let i=[],s=[];const d={padding:"10px 5px 10px 15px",position:"fixed",right:"0",top:"80%",cursor:"pointer",backgroundColor:"grey",color:"white",borderRadius:"32px 0 0 32px",fontSize:"15px",transition:"all 0.3s ease",zIndex:"999"},u={backgroundColor:"#8654cc"},p=e("button","btnStart","Запустить");Object.assign(p.style,d),p.addEventListener("click",(function(){document.querySelector(".catalog-items-list > div:first-child .catalog-item-photo img:first-child")&&(function(){i=[],s=[];let c=!0,r=[];s=Array.from(document.querySelectorAll(".catalog-items-list > div:not(.catalog-item_out-of-stock):not(.catalog-item_banner):not(.catalog-item_banner"));const d=function(e){const t=function(e){let t=document.querySelector(e);if(t)return t;{const t=new MutationObserver((n=>{const o=document.querySelector(e);if(o)return t.disconnect(),o}));t.observe(document.documentElement,{childList:!0,subtree:!0})}}(".catalog-listing-controls");return t}(),u=e("div","table_parent__content"),p=e("div","buttonShow_wrap"),m=e("div","promocode_wrap"),h=e("h3","promocode-list__title","Выберите промокоды которые вы уже использовали");m.appendChild(h);const f=e("div","promocode-checkboxes-wrap"),g=e("label","promocode-checkboxes-label","Использовать промокоды");g.htmlFor="promocode-checkboxes";const b=document.createElement("input");b.type="checkbox",b.id="promocode-checkboxes",b.classList.add("promocode-checkboxes"),f.append(b,g);const y=function(n){const o=e("div","promocode-list");for(const e in n){const c=t(e,n[e]);o.appendChild(c)}return o}(x);m.appendChild(y),d.appendChild(u),u.appendChild(p);const k=e("table","ext-table");d.appendChild(k);const v=e("thead","ext-thead"),S=e("tr","ext-tr");v.appendChild(S),k.appendChild(v);const q=e("tbody","ext-tbody");k.appendChild(q);let L=[];L=[{name:"Название",atr:"name"},{name:"Магазин",atr:"shop"},{name:"Цена",atr:"price"},{name:"Бонусы %",atr:"bonus"},{name:"Итого",atr:"total"},{name:"Промокод",atr:"promocode"}],L.forEach((t=>{const c=e("td","ext-td"),r=e("a","ext-td-link",t.name);r.href="#",c.appendChild(r),S.appendChild(c),r.addEventListener("click",(e=>{e.preventDefault(),"name"===t.atr?n(i,q,"name"):"shop"===t.atr?n(i,q,"shop"):"price"===t.atr?n(i,q,"price"):"bonus"===t.atr?function(e,t,n="default"){let c=[...e];c.sort(((e,t)=>e[n]>t[n]?-1:e[n]<t[n]?1:0)),o(c,t)}(i,q,"bonus"):"total"===t.atr?n(i,q,"total"):"promocode"===t.atr&&n(i,q,"promocode")}))}));let T=1,E=e("span","ext-count_page");null!==E?E.innerText=T>1?`Загруженно страниц: ${T}`:"Загруженно страниц: 1":console.log("count_page отсутсвует");let C=e("button","ext-button","Загрузить еще товары");C.addEventListener("click",(()=>{const e=document.querySelector(".catalog-items-list__show-more");if(!e||T>11)return C.disabled=!0,C.classList.add("disabled"),M.disabled=!0,void M.classList.add("disabled");e.click(),setTimeout((()=>{F(),E?(T++,E.innerText=T>1?`Загруженно страниц: ${T}`:"Загруженно страниц: 1"):console.log("count_page отсутсвует"),o(i,q)}),500)}));let w=e("span","ext-count_products");w.innerText=a(s);const M=e("button","ext-button","Автозагрузка товаров");let A,I=!1;M.addEventListener("click",(()=>{!0===I?(I=!1,M.innerText="Автозагрузка товаров",clearTimeout(A)):(I=!0,M.innerText="Отключить автозагрузку",A||D())}));const j=e("button","ext-button","Открыть таблицу");function H(){!0===c&&(k.classList.toggle("active"),k.classList.contains("active")?(j.innerText="Скрыть таблицу",q.innerHTML=""):j.innerText="Открыть таблицу",setTimeout((()=>{$(),F(),w.innerText=a(s),o(i,q)}),500))}j.addEventListener("click",H),b.addEventListener("change",(function(){this.checked?(c=!1,m.style.display="flex"):(c=!0,m.style.display="none",_=[],$(),F(),q.innerHTML="",o(i,q))}));const O=e("button","ext-button","Выбрать");function $(){i=[]}function D(){let e=document.querySelector(".catalog-items-list__show-more");F(),w.innerText=a(s),o(i,q),e&&T<11?(e.click(),A=setTimeout((function(){D(),T++,E.innerText=T>1?`Загруженно страниц: ${T}`:"Загруженно страниц: 1"}),3e3)):(M.disabled=!0,M.classList.add("disabled"))}function F(){if(s=Array.from(document.querySelectorAll(".catalog-items-list > div:not(.catalog-item_out-of-stock):not(.catalog-item_banner):not(.catalog-item_banner")),s&&0!==s.length){if(s.forEach((e=>{let t=e.id;if(!i.some((e=>e.id===t))){let n=e.querySelector(".catalog-item-regular-desktop__main-info > a.ddl_product_link");null!==n&&(n=n.innerText.replace(/[%\u20BD]/g,""));let o=null!==e.querySelector(".catalog-item-regular-desktop__main-info > a.ddl_product_link")?e.querySelector(".catalog-item-regular-desktop__main-info > a.ddl_product_link").href:"https://megamarket.ru/",r=null!==e.querySelector(".merchant-info__name")?e.querySelector(".merchant-info__name").innerText:"Неизвестен",a=null!==e.querySelector(".catalog-item__merchant-info")?e.querySelector(".catalog-item__merchant-info").href:"https://megamarket.ru/",s=null!==e.querySelector(".catalog-item-regular-desktop__price")?parseInt(e.querySelector(".catalog-item-regular-desktop__price").innerText.replace(/[^\d]/g,"").trim()):"-",d="";!0===c&&(s=l(parseInt(e.querySelector(".catalog-item-regular-desktop__price").innerText.replace(/[^\d]/g,"").trim()),_,"price"),d=l(parseInt(e.querySelector(".catalog-item-regular-desktop__price").innerText.replace(/[^\d]/g,"").trim()),_,"promo"));let u=null!==e.querySelector(".bonus-percent")?parseInt(e.querySelector(".bonus-percent").innerText)||"-":1;const p=function(e,t){if(!e||!t)return 0;let n=e,o=parseFloat(t);n=parseInt(n),o=parseInt(o);let c=n*o/100;return c=Math.ceil(c),n-c}(s,u);i.push({id:t,name:n,namelink:o,shop:r,shopLink:a,price:s,bonus:u,promocode:d,total:p})}})),!s)return console.log("Карточек нет");w&&(w.innerText=a(s))}else console.log("Карточек нет или массив пуст")}O.addEventListener("click",(()=>{r=[],c=!0,m.style.display="none",document.querySelectorAll('.promocode_wrap input[type="checkbox"]').forEach((function(e){e.checked||r.push(e.value)}));for(const e in x)r.includes(e)&&(_[e]=x[e]);H()})),m.appendChild(O),p.append(C,w,M,E,j,f,m)}(),p.disabled=!0,_=[])}));const m=new MutationObserver((function(e,t){for(const t of e)if("childList"===t.type&&t.addedNodes.length>0){if(document.querySelector(".catalog-items-list > div:first-child .catalog-item-photo img:first-child"))return Object.assign(p.style,u),p.disabled=!1,void b();Object.assign(p.style,d)}})),h={childList:!0,subtree:!0};let f=!1;function g(){f||(m.observe(document.body,h),f=!0)}function b(){f&&(m.disconnect(),f=!1)}let _=[],x=[];chrome.runtime.onMessage.addListener((function(e,t,n){"url-changed"===e.message&&(g(),console.log("смена урла")),document.querySelector(".table_parent__content")&&document.querySelector(".ext-table")&&(document.querySelector(".table_parent__content").remove(),document.querySelector(".ext-table").remove())})),fetch("https://borislav2515.github.io/tour/promocode.json").then((e=>e.json())).then((e=>{x=e})).catch((e=>{console.error("Ошибка при загрузке файла:",e)})),window.addEventListener("load",(function(){const e=document.createElement("link"),t=chrome.runtime.getURL("style.css");e.rel="stylesheet",e.type="text/css",e.href=t,document.head.appendChild(e);let n=window.location.pathname;document.querySelector("body").append(p),p.disabled="/catalog/"===n||"/brands/"===n,g()}))})();